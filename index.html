<html>

<head>
  <title>CSç«‹ä½“å›³</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/pmtiles@2.11.0/dist/index.js"></script>
  <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.2.0/dist/maplibre-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.2.0/dist/maplibre-gl-geocoder.css"
    type="text/css" />
  <style>
    body {
      margin: 0;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .map-overlay {
      font: bold 12px/14px "Helvetica Neue", Arial, Helvetica, sans-serif;
      position: absolute;
      width: 180px;
      bottom: 20px;
      left: 0;
      padding: 10px;
    }

    .map-overlay .map-overlay-inner {
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .map-overlay label {
      display: block;
      margin: 0 0 0px;
      font-size: 12px;
      top: 100px;
      left: 10px;
      display: block;
      margin-bottom: 5px;
    }

    .map-overlay input {
      background-color: transparent;
      display: inline-block;
      width: 100%;
      position: relative;
      margin: 0;
      cursor: ew-resize;
    }

    .maplibregl-popup .maplibregl-popup-content {
      padding: 8px 10px;
      font: 12px/14px Arial, Helvetica, sans-serif;
      color: black;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      width: 280px;
      height: auto;
      /*overflow: scroll;*/
    }

    .maplibregl-ctrl-geocoder {
      font-size: 14px;
      line-height: 12px;
      font-family: "Open Sans", "Helvetica Neue", Arial, Helvetica, sans-serif;
      position: relative;
      background-color: rgba(255, 255, 255, 1);
      width: 80%;
      min-width: 100px;
      z-index: 1;
      border-radius: 5px;
      transition: width 0.25s, min-width 0.25s;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .maplibregl-ctrl-geocoder .suggestions {
      font-size: 14px;
    }

    #info {
      width: 240px;
      padding: 6px 8px;
      font: 12px/14px Arial, Helvetica, sans-serif;
      color: navy;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      width: fit-content;
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      max-height: 250px;
      overflow-y: auto;
    }

    #info details>fieldset {
      padding: 0;
      margin-bottom: 8px;
    }

    .yubi {
      cursor: pointer;
      z-index: 10;
    }

    .checkbox-button-container {
      display: flex;
      flex-direction: column;
      justify-content: start;
    }

    .column {
      display: flex;
      flex-direction: column;
      margin-right: 20px;
    }

    .map-center-marker {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 30px;
      pointer-events: none;
    }

    .coords-display {
      position: absolute;
      font: bold 12px/14px "Helvetica Neue", Arial, Helvetica, sans-serif;
      bottom: 125px;
      left: 0px;
      margin: 10px;
      padding: 5px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 5px;
      font-size: 12px;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="map-center-marker">+</div>
  <div class="coords-display" id="coords"></div>
  <div id="info">
    <details>
      <summary class="yubi">
        <strong>CSç«‹ä½“å›³</strong>
      </summary>
      <fieldset>
        <div class="checkbox-button-container">
          <div class="column">
            <div>
              <input type="checkbox" id="fukushima-cs" value="fukushima-cs" />
              <label for="fukushima-cs">ç¦å³¶çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="tochigi-cs" value="tochigi-cs" />
              <label for="tochigi-cs">æ ƒæœ¨çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="tokyo-23ku-cs" value="tokyo-23ku-cs" />
              <label for="toyko-23ku-cs">æ±äº¬éƒ½(åŒºéƒ¨)CSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="tokyo-tama-cs" value="tokyo-tama-cs" />
              <label for="toyko-tama-cs">æ±äº¬éƒ½(å¤šæ‘©åœ°åŸŸ)CSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="tokyo-shima-cs" value="tokyo-shima-cs" />
              <label for="toyko-shima-cs">æ±äº¬éƒ½(å³¶ã—ã‚‡åœ°åŸŸ)CSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="kanagawa-cs" value="kanagawa-cs" />
              <label for="kanagawa-cs">ç¥å¥ˆå·çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="nagaoka-cs" value="nagaoka-cs" />
              <label for="nagaoka-cs">é•·å²¡åœ°åŸŸCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="toyama-cs" value="toyama-cs" checked />
              <label for="toyama-cs">å¯Œå±±çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="noto-cs" value="noto-cs" />
              <label for="noto-cs">èƒ½ç™»(çŸ³å·çœŒ)CSç«‹ä½“å›³(ç™ºç½å¾Œé€Ÿå ±æˆæœ)</label>
            </div>
            <div>
              <input type="checkbox" id="noto-cs-final" value="noto-final" />
              <label for="noto-cs-final">èƒ½ç™»(çŸ³å·çœŒ)CSç«‹ä½“å›³(ç™ºç½å¾Œæœ€çµ‚æˆæœ)</label>
            </div>
            <div>
              <input type="checkbox" id="yamanashi-cs" value="yamanashi-cs" />
              <label for="yamanashi-cs">å±±æ¢¨çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="nagano-cs" value="nagano-cs" />
              <label for="nagano-cs">é•·é‡çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="gifu-cs" value="gifu-cs" />
              <label for="gifu-cs">å²é˜œçœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="shizuoka-cs" value="shizuoka-cs" />
              <label for="shizuoka-cs">é™å²¡çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="kyoto-cs" value="kyoto-cs" />
              <label for="kyoto-cs">äº¬éƒ½åºœCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="osaka-cs" value="osaka-cs" />
              <label for="osaka-cs">å¤§é˜ªåºœCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="hyogo-cs" value="hyogo-cs" />
              <label for="hyogo-cs">å…µåº«çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="wakayama-cs" value="wakayama-cs" />
              <label for="wakayama-cs">å’Œæ­Œå±±çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="tottori-cs" value="tottori-cs" />
              <label for="tottori-cs">é³¥å–çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="okayama-cs" value="okayama-cs" />
              <label for="okayama-cs">å²¡å±±çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="hiroshima-cs" value="hiroshima-cs" />
              <label for="hiroshima-cs">åºƒå³¶çœŒCSç«‹ä½“å›³(æ—é‡åº0.5m)</label>
            </div>
            <div>
              <input type="checkbox" id="hiroshima-05m-cs" value="hiroshima-05m-cs" />
              <label for="hiroshima-05m-cs">åºƒå³¶çœŒCSç«‹ä½“å›³(åºƒå³¶çœŒ0.5m)</label>
            </div>
            <div>
              <input type="checkbox" id="hiroshima-1m-cs" value="hiroshima-1m-cs" />
              <label for="hiroshima-1m-cs">åºƒå³¶çœŒCSç«‹ä½“å›³(åºƒå³¶çœŒ1m)</label>
            </div>
            <div>
              <input type="checkbox" id="ehime-cs" value="ehime-cs" />
              <label for="ehime-cs">æ„›åª›çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="kochi-cs" value="kochi-cs" />
              <label for="kochi-cs">é«˜çŸ¥çœŒCSç«‹ä½“å›³</label>
            </div>
            <div>
              <input type="checkbox" id="kumamoto-oita-cs" value="kumamoto-oita-cs" />
              <label for="kumamoto-oita-cs">ç†Šæœ¬çœŒãƒ»å¤§åˆ†çœŒCSç«‹ä½“å›³</label>
            </div>
          </div>
        </div>
      </fieldset>
      <summary class="yubi">
        <strong>å„ç¨®ãƒ¬ã‚¤ãƒ¤ãƒ¼</strong>
      </summary>
      <fieldset>
        <div class="checkbox-button-container">
          <div class="column">
            <div>
              <input type="checkbox" id="landslide" value="landslide" />
              <label for="landslide">åœ°ã™ã¹ã‚Šåœ°å½¢åˆ†å¸ƒå›³</label>
              <label id="open-legend-landslide" style="text-decoration: underline; cursor: pointer">å‡¡ä¾‹</label>
            </div>
            <div>
              <input type="checkbox" id="moj-xml" value="moj-xml" />
              <label for="moj-xml">æ³•å‹™çœåœ°å›³XML(2024å¹´)</label>
            </div>
            <div>
              <input type="checkbox" id="plateau-lod1" value="plateau-lod1" />
              <label for="plateau-lod1">3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ«PLATEAUå»ºç¯‰ç‰©LOD1(123éƒ½å¸‚)</label>
            </div>
          </div>
        </div>
      </fieldset>
    </details>
  </div>
  <div class="map-overlay top">
    <div class="map-overlay-inner">
      <label>CSç«‹ä½“å›³ ä¸é€æ˜åº¦:
        <span id="cs-slider-opacity-value">80%</span></label>
      <input id="cs-slider-opacity" type="range" min="0" max="100" step="1" value="80" />
      <label>é™°å½±èµ·ä¼å›³ ä¸é€æ˜åº¦:
        <span id="hillshade-slider-opacity-value">0%</span></label>
      <input id="hillshade-slider-opacity" type="range" min="0" max="100" step="1" value="0" />
    </div>
  </div>
  <script type="module">
    // Protocolã®è¨­å®š
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', (request) => {
      return new Promise((resolve, reject) => {
        const callback = (err, data) => {
          if (err) {
            reject(err);
          } else {
            resolve({ data });
          }
        };
        protocol.tile(request, callback);
      });
    });

    // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
    const map = new maplibregl.Map({
      container: "map",
      style: "./style/mono.json",
      zoom: 9.39,
      minZoom: 0,
      maxZoom: 23,
      pitch: 0,
      bearing: 0,
      maxPitch: 85,
      center: [137.2426, 36.6161],
      hash: true,
      attributionControl: false,
    });

    //ã‚¸ã‚ªã‚³ãƒ¼ãƒ€ãƒ¼ï¼ˆå›½åœŸåœ°ç†é™¢ åœ°åæ¤œç´¢APIï¼‰
    var geocoder_api = {
      forwardGeocode: async (config) => {
        const features = [];
        const Text_Prefix = config.query.substr(0, 3);
        try {
          let request =
            "https://msearch.gsi.go.jp/address-search/AddressSearch?q=" +
            config.query;
          const response = await fetch(request);
          const geojson = await response.json();

          for (var i = 0; i < geojson.length; i++) {
            if (geojson[i].properties.title.indexOf(Text_Prefix) !== -1) {
              let point = {
                type: "Feature",
                geometry: {
                  type: "Point",
                  coordinates: geojson[i].geometry.coordinates,
                },
                place_name: geojson[i].properties.title,
                properties: geojson[i].properties,
                text: geojson[i].properties.title,
                place_type: ["place"],
                center: geojson[i].geometry.coordinates,
              };
              features.push(point);
            }
          }
        } catch (e) {
          console.error(`Failed to forwardGeocode with error: ${e}`);
        }
        return {
          features: features,
        };
      },
    };
    map.addControl(
      new MaplibreGeocoder(geocoder_api, { maplibregl: maplibregl }),
      "top-right"
    );

    // ã‚ºãƒ¼ãƒ ãƒ»å›è»¢
    map.addControl(new maplibregl.NavigationControl());

    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ³ã‚ªãƒ•
    map.addControl(new maplibregl.FullscreenControl());

    // ç¾åœ¨ä½ç½®è¡¨ç¤º
    map.addControl(
      new maplibregl.GeolocateControl({
        positionOptions: {
          enableHighAccuracy: false,
        },
        fitBoundsOptions: { maxZoom: 18 },
        trackUserLocation: true,
        showUserLocation: true,
      })
    );

    // ã‚¹ã‚±ãƒ¼ãƒ«è¡¨ç¤º
    map.addControl(
      new maplibregl.ScaleControl({
        maxWidth: 200,
        unit: "metric",
      })
    );

    // Attributionã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º
    map.addControl(
      new maplibregl.AttributionControl({
        compact: true,
        customAttribution:
          'ï¼ˆ<a href="https://twitter.com/shi__works" target="_blank">X(æ—§Twitter)</a> | <a href="https://github.com/shiwaku/aist-dem-with-cs-map-on-maplibre" target="_blank">GitHub</a>ï¼‰ ',
      })
    );

    // 3Dåœ°å½¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
    map.addControl(
      new maplibregl.TerrainControl({
        source: 'aist-dem-terrain-rgb',
        exaggeration: 1 // æ¨™é«˜ã‚’å¼·èª¿ã™ã‚‹å€ç‡
      })
    );

    map.on("load", () => {
      // ç”£ç·ç ” ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹æ¨™é«˜ã‚¿ã‚¤ãƒ«ã‚½ãƒ¼ã‚¹
      map.addSource("aist-dem-terrain-rgb", {
        type: 'raster-dem',
        tiles: ["https://gbank.gsj.jp/seamless/elev/terrainRGB/land/{z}/{y}/{x}.png"],
        attribution: '<a href="https://tiles.gsj.jp/tiles/elev/tiles.html" target="_blank">ç”£ç·ç ” ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹æ¨™é«˜ã‚¿ã‚¤ãƒ«(é™¸åŸŸçµ±åˆDEM)</a>',
        tileSize: 256
      });

      // ç”£ç·ç ” ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹æ¨™é«˜ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
      // map.setTerrain({ 'source': 'aist-dem-terrain-rgb', 'exaggeration': 1 });

      // æ³•å‹™çœåœ°å›³XMLï¼ˆPMTilesï¼‰ã‚½ãƒ¼ã‚¹
      map.addSource("moj-xml", {
        type: "vector",
        url: "pmtiles://https://data.source.coop/smartmaps/amx-2024-04/MojMap_amx_2024.pmtiles",
        // url: "pmtiles://https://pmtiles-data.s3.ap-northeast-1.amazonaws.com/moj-xml/MojMap_amx_2024.pmtiles",
        attribution: '<a href="https://github.com/amx-project">æ³•å‹™çœåœ°å›³XMLï¼ˆamx-projectï¼‰</a>'
      });

      // ç­†ãƒ¬ã‚¤ãƒ¤ï¼ˆãƒãƒªã‚´ãƒ³ï¼‰
      map.addLayer({
        "id": "fude-polygon",
        "source": "moj-xml",
        "source-layer": "fude",
        "type": "fill",
        "layout": {
          "visibility": "none",
        },
        "paint": {
          'fill-color': '#FFF2CC',
          'fill-opacity': 0.2
        }
      });

      // ç­†ãƒ¬ã‚¤ãƒ¤ï¼ˆãƒ©ã‚¤ãƒ³ï¼‰
      map.addLayer({
        "id": "fude-line",
        "source": "moj-xml",
        "source-layer": "fude",
        "type": "line",
        "layout": {
          "visibility": "none",
        },
        "paint": {
          'line-color': '#FF3232',
          'line-width': 1
        }
      });

      // 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ«PLATEAUå»ºç¯‰ç‰©ãƒ¢ãƒ‡ãƒ«ï¼ˆPMTilesï¼‰ã‚½ãƒ¼ã‚¹
      map.addSource("plateau-lod1", {
        type: "vector",
        url: "pmtiles://https://shiworks.xsrv.jp/pmtiles-data/plateau/PLATEAU_2022_LOD1.pmtiles",
        // url: "pmtiles://https://pmtiles-data.s3.ap-northeast-1.amazonaws.com/plateau/PLATEAU_2022_LOD1.pmtiles",
        minzoom: 16,
        maxzoom: 16,
        attribution:
          '<a href="https://www.geospatial.jp/ckan/dataset/plateau">å›½åœŸäº¤é€šçœ 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ«PLATEAUï¼ˆå»ºç¯‰ç‰©LOD1ï¼‰</a>',
      });

      // 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ«PLATEAUå»ºç¯‰ç‰©ãƒ¢ãƒ‡ãƒ«ï¼ˆPMTilesï¼‰ãƒ¬ã‚¤ãƒ¤
      map.addLayer({
        id: "plateau-lod1",
        source: "plateau-lod1",
        "source-layer": "PLATEAU",
        minzoom: 14,
        maxzoom: 23,
        type: "fill-extrusion",
        layout: {
          visibility: "none",
        },
        paint: {
          "fill-extrusion-color": "#FFFFFF",
          "fill-extrusion-opacity": 0.7,
          "fill-extrusion-height": ["get", "measuredHeight"],
        },
      });

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼CSç«‹ä½“å›³ã®ä¸é€æ˜åº¦ã‚’åˆ¶å¾¡
      const cs_sliderOpactiy = document.getElementById("cs-slider-opacity");
      const cs_sliderOpactiyValue = document.getElementById(
        "cs-slider-opacity-value"
      );

      cs_sliderOpactiy.addEventListener("input", (e) => {
        map.setPaintProperty(
          "nagano-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "hiroshima-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "hiroshima-05m-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "hiroshima-1m-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "okayama-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "ehime-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "kochi-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "fukushima-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "kumamoto-oita-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "hyogo-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tochigi-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "shizuoka-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "gifu-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "osaka-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "nagaoka-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "noto-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "noto-cs-final",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-23ku-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-tama-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-01-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-02-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-03-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-04-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-05-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tokyo-shima-06-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "wakayama-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "kanagawa-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "tottori-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "kyoto-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "yamanashi-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        map.setPaintProperty(
          "toyama-cs",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        cs_sliderOpactiyValue.textContent = e.target.value + "%";
      });

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§é™°å½±èµ·ä¼å›³ã®ä¸é€æ˜åº¦ã‚’åˆ¶å¾¡
      const hillshade_sliderOpactiy = document.getElementById(
        "hillshade-slider-opacity"
      );
      const hillshade_sliderOpactiyValue = document.getElementById(
        "hillshade-slider-opacity-value"
      );

      hillshade_sliderOpactiy.addEventListener("input", (e) => {
        map.setPaintProperty(
          "hillshade",
          "raster-opacity",
          parseInt(e.target.value, 10) / 100
        );
        hillshade_sliderOpactiyValue.textContent = e.target.value + "%";
      });

      // Skyãƒ¬ã‚¤ãƒ¤
      map.setSky({
        "sky-color": "#199EF3",
        "sky-horizon-blend": 0.7,
        "horizon-color": "#f0f8ff",
        "horizon-fog-blend": 0.8,
        "fog-color": "#2c7fb8",
        "fog-ground-blend": 0.9,
        "atmosphere-blend": ["interpolate", ["linear"], ["zoom"], 0, 1, 12, 0]
      });

      updateCoordsDisplay(); // åˆæœŸåº§æ¨™ã‚’è¡¨ç¤º

      // map.showTileBoundaries = true; // ã‚¿ã‚¤ãƒ«å¢ƒç•Œ

    });

    // åœ°å›³ã®ä¸­å¿ƒåº§æ¨™ã¨æ¨™é«˜ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    /*
    function updateCoordsDisplay() {
      let center = map.getCenter();
      let lat = center.lat.toFixed(5);
      let lng = center.lng.toFixed(5);
      // let elevTile = 'https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png' // çµ±åˆDEM
      let elevTile = 'https://tiles.gsj.jp/tiles/elev/land/{z}/{y}/{x}.png' // é™¸åŸŸçµ±åˆDEM
      getNumericalValue(elevTile, lat, lng, Math.trunc(map.getZoom()), 0.01, 0, -(2 ** 23)).then(function (v) {
        document.getElementById("coords").innerHTML =
          "ä¸­å¿ƒåº§æ¨™: " + lat + ", " + lng + "<br>" +
          "æ¨™é«˜(ZL=15ä»¥ä¸‹): " + ((isNaN(v)) ? 'å–å¾—ã§ãã¾ã›ã‚“' : v.toFixed(2) + 'm') + "<br>" +
          '<a href="https://www.google.com/maps?q=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸŒGoogleMaps</a>' +
          " " + '<a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸ“·StreetView</a>';
      });
    }
    */

    function updateCoordsDisplay() {
      let center = map.getCenter();
      let lat = center.lat.toFixed(5);
      let lng = center.lng.toFixed(5);
      let zoomLevel = Math.trunc(map.getZoom());
      // let elevTile = 'https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png'; // çµ±åˆDEM
      let elevTile = 'https://tiles.gsj.jp/tiles/elev/land/{z}/{y}/{x}.png'; // é™¸åŸŸçµ±åˆDEM

      if (zoomLevel > 15) {
        document.getElementById("coords").innerHTML =
          "ä¸­å¿ƒåº§æ¨™: " + lat + ", " + lng + "<br>" +
          "ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«: " + map.getZoom().toFixed(2) + "<br>" +
          "æ¨™é«˜(ZL15ä»¥ä¸‹): å–å¾—ã§ãã¾ã›ã‚“<br>" +
          '<a href="https://www.google.com/maps?q=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸŒGoogleMaps</a>' +
          " " + '<a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸ“·StreetView</a>';
      } else {
        getNumericalValue(elevTile, lat, lng, zoomLevel, 0.01, 0, -(2 ** 23)).then(function (v) {
          document.getElementById("coords").innerHTML =
            "ä¸­å¿ƒåº§æ¨™: " + lat + ", " + lng + "<br>" +
            "ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«: " + map.getZoom().toFixed(2) + "<br>" +
            "æ¨™é«˜(ZL15ä»¥ä¸‹):" + ((isNaN(v)) ? 'å–å¾—ã§ãã¾ã›ã‚“' : v.toFixed(2) + 'm') + "<br>" +
            '<a href="https://www.google.com/maps?q=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸŒGoogleMaps</a>' +
            " " + '<a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=' + lat + "," + lng + '&hl=ja" target="_blank">ğŸ“·StreetView</a>';
        });
      }
    }


    // åœ°å›³ãŒç§»å‹•ã—ãŸã‚‰ä¸­å¿ƒã®åº§æ¨™ã‚’æ›´æ–°
    map.on("move", function () {
      updateCoordsDisplay(); // åº§æ¨™ã‚’æ›´æ–°
    });

    // ============================== ãƒ¬ã‚¤ãƒ¤ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆåˆ¶å¾¡ ==============================

    // ãƒ¬ã‚¤ãƒ¤è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function toggleMapLayerVisibility(checkboxId, layerId) {

      // ç‰¹æ®Šãªå‡¦ç†ãŒå¿…è¦ãªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹IDã‚’é…åˆ—ã§å®šç¾©
      const specialCheckboxIds = ["tokyo-shima-cs", "moj-xml"];

      if (!specialCheckboxIds.includes(checkboxId)) {
        // é€šå¸¸ã®å‡¦ç†
        document
          .getElementById(checkboxId)
          .addEventListener("change", function (e) {
            map.setLayoutProperty(
              layerId,
              "visibility",
              e.target.checked ? "visible" : "none"
            );
          });
      } else {
        // ç‰¹æ®Šãªå‡¦ç†
        document
          .getElementById(checkboxId)
          .addEventListener("change", function (e) {
            let relatedLayers = [];

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹IDã«å¿œã˜ã¦é–¢é€£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨­å®š
            if (checkboxId === "tokyo-shima-cs") {
              relatedLayers = [
                "tokyo-shima-01-cs",
                "tokyo-shima-02-cs",
                "tokyo-shima-03-cs",
                "tokyo-shima-04-cs",
                "tokyo-shima-05-cs",
                "tokyo-shima-06-cs"
              ];
            } else if (checkboxId === "moj-xml") {
              relatedLayers = ["fude-line", "fude-polygon"];
            }

            // ã™ã¹ã¦ã®é–¢é€£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® visibility ã‚’è¨­å®š
            relatedLayers.forEach(layer => {
              map.setLayoutProperty(
                layer,
                "visibility",
                e.target.checked ? "visible" : "none"
              );
            });
          });
      }
    }

    // ãƒ¬ã‚¤ãƒ¤è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆåˆ¶å¾¡
    // CSç«‹ä½“å›³
    toggleMapLayerVisibility("fukushima-cs", "fukushima-cs");
    toggleMapLayerVisibility("tochigi-cs", "tochigi-cs");
    toggleMapLayerVisibility("tokyo-23ku-cs", "tokyo-23ku-cs");
    toggleMapLayerVisibility("tokyo-tama-cs", "tokyo-tama-cs");
    toggleMapLayerVisibility("tokyo-shima-cs", "tokyo-shima-cs");
    toggleMapLayerVisibility("kanagawa-cs", "kanagawa-cs");
    toggleMapLayerVisibility("nagaoka-cs", "nagaoka-cs");
    toggleMapLayerVisibility("toyama-cs", "toyama-cs");
    toggleMapLayerVisibility("noto-cs", "noto-cs");
    toggleMapLayerVisibility("noto-cs-final", "noto-cs-final");
    toggleMapLayerVisibility("yamanashi-cs", "yamanashi-cs");
    toggleMapLayerVisibility("nagano-cs", "nagano-cs");
    toggleMapLayerVisibility("gifu-cs", "gifu-cs");
    toggleMapLayerVisibility("shizuoka-cs", "shizuoka-cs");
    toggleMapLayerVisibility("kyoto-cs", "kyoto-cs");
    toggleMapLayerVisibility("osaka-cs", "osaka-cs");
    toggleMapLayerVisibility("hyogo-cs", "hyogo-cs");
    toggleMapLayerVisibility("wakayama-cs", "wakayama-cs");
    toggleMapLayerVisibility("tottori-cs", "tottori-cs");
    toggleMapLayerVisibility("okayama-cs", "okayama-cs");
    toggleMapLayerVisibility("hiroshima-cs", "hiroshima-cs");
    toggleMapLayerVisibility("hiroshima-05m-cs", "hiroshima-05m-cs");
    toggleMapLayerVisibility("hiroshima-1m-cs", "hiroshima-1m-cs");
    toggleMapLayerVisibility("ehime-cs", "ehime-cs");
    toggleMapLayerVisibility("kochi-cs", "kochi-cs");
    toggleMapLayerVisibility("kumamoto-oita-cs", "kumamoto-oita-cs");

    // CSç«‹ä½“å›³ä»¥å¤–
    toggleMapLayerVisibility("plateau-lod1", "plateau-lod1");
    toggleMapLayerVisibility("moj-xml", "moj-xml");
    toggleMapLayerVisibility("landslide", "landslide");

    // åœ°ã™ã¹ã‚Šåœ°å½¢åˆ†å¸ƒå›³å‡¡ä¾‹

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("open-legend-landslide")
        .addEventListener("click", OpenLegendRoad);
    });

    function OpenLegendRoad() {
      // å‡¡ä¾‹ã®å†…å®¹ã‚’å«ã‚€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã®URL
      var legendUrl = "./PNG/legend-landslide.png";

      // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
      window.open(legendUrl, "Legend", "width=1800,height=1200");
    }

    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point); // ã‚¯ãƒªãƒƒã‚¯åœ°ç‚¹ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’å–å¾—

      if (features.length === 0) return; // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

      let popupContent = '';
      const uniqueLayers = []; // å‡¦ç†æ¸ˆã¿ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’è¨˜éŒ²

      features.forEach((feature) => {
        const layerId = feature.layer ? feature.layer.id : null; // ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’å–å¾—

        if (!layerId) {
          console.warn('ãƒ¬ã‚¤ãƒ¤ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', feature);
          return; // ãƒ¬ã‚¤ãƒ¤ãƒ¼IDãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        }

        if (!uniqueLayers.includes(layerId)) {
          uniqueLayers.push(layerId); // å‡¦ç†æ¸ˆã¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨˜éŒ²

          // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ã‚’è¿½åŠ 
          const properties = feature.properties; // ãƒ•ã‚£ãƒ¼ãƒãƒ£ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—
          if (layerId === 'plateau-lod1') {
            popupContent += `
          <div><strong>å»ºç¯‰ç‰©ãƒ¢ãƒ‡ãƒ«LOD1:</strong></div>
          <div>id: ${properties['id']}</div>
          <div>source: ${properties['source']}</div>
          <div>type: ${properties['type']}</div>
          <div>lod: ${properties['lod']}</div>
          <div>measuredHeight: ${properties['measuredHeight']}</div>
          <div>address: ${properties['address']}</div>
          <div>buildingID: ${properties['buildingID']}</div>
          <div>prefecture: ${properties['prefecture']}</div>
          <div>city: ${properties['city']}</div>
          <div>lod1HeightType: ${properties['lod1HeightType']}</div>
          <br>
        `;
          } else if (layerId === 'fude-polygon') {
            popupContent += `
          <div><strong>æ³•å‹™çœåœ°å›³XML:</strong></div>
          <div>åº§æ¨™ç³»: ${properties['åº§æ¨™ç³»']}</div>
          <div>æ¸¬åœ°ç³»åˆ¤åˆ¥: ${properties['æ¸¬åœ°ç³»åˆ¤åˆ¥']}</div>
          <div>åœ°å›³å: ${properties['åœ°å›³å']}</div>
          <div>ç¸®å°ºåˆ†æ¯: ${properties['ç¸®å°ºåˆ†æ¯']}</div>
          <div>åœ°ç•ªåŒºåŸŸ: ${properties['åœ°ç•ªåŒºåŸŸ']}</div>
          <div>åœ°ç•ª: ${properties['åœ°ç•ª']}</div>
          <div>åº§æ¨™å€¤ç¨®åˆ¥: ${properties['åº§æ¨™å€¤ç¨®åˆ¥']}</div>
          <br>
        `;
          }
        }
      });

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦è¡¨ç¤º
      if (popupContent) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat) // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨­å®š
          .setHTML(popupContent.trim()) // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’è¨­å®š
          .addTo(map); // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’åœ°å›³ã«è¿½åŠ 
      }
    });

    /// ****************
    // latLngToTile ç·¯åº¦çµŒåº¦ã‚’ã‚¿ã‚¤ãƒ«åº§æ¨™ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    //  latLng: ç·¯åº¦çµŒåº¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆlat,lngãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã¾ã™ï¼‰
    //  z: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
    //  æˆ»ã‚Šå€¤: ã‚¿ã‚¤ãƒ«åº§æ¨™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆx, yãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã¾ã™)
    //    â€»é€šå¸¸ï¼Œåœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã«åŒæ§˜ã®é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼
    /// ****************
    /*
    function latLngToTile(lat, lng, z) {
      console.log("z=" + z + " " + "lat=" + lat + " " + "lng=" + lng);
      const
        w = Math.pow(2, (z === undefined) ? 0 : z) / 2,		// ä¸–ç•Œå…¨ä½“ã®ãƒ”ã‚¯ã‚»ãƒ«å¹…
        yrad = Math.log(Math.tan(Math.PI * (90 + lat) / 360));

      return { x: (lng / 180 + 1) * w, y: (1 - yrad / Math.PI) * w };
    };
    */

    function latLngToTile(lat, lng, z) {
      // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ« z ã«ãŠã‘ã‚‹ã‚¿ã‚¤ãƒ«ã®ç·æ•°
      const n = Math.pow(2, z);
      // çµŒåº¦ lng â†’ ã‚¿ã‚¤ãƒ« X åº§æ¨™
      const x = ((lng / 180 + 1) * n) / 2;
      // ç·¯åº¦ lat â†’ ã‚¿ã‚¤ãƒ« Y åº§æ¨™
      // (ãƒ¡ãƒ«ã‚«ãƒˆãƒ«æŠ•å½±ã«ã‚ˆã‚‹å¤‰æ›)
      const latRad = lat * Math.PI / 180;  // ç·¯åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
      const y = n * (
        1 - Math.log(
          Math.tan(latRad) + 1 / Math.cos(latRad)
        ) / Math.PI
      ) / 2;

      return { x, y };
    }

    /// ****************
    // getNumericalValue ã‚¿ã‚¤ãƒ«URLï¼Œåº§æ¨™ï¼Œã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®šã—ã¦æ•°å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //	url: ã‚¿ã‚¤ãƒ«ç”»åƒã®URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼
    //		ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ï¼ŒX, Yåº§æ¨™ã‚’ãã‚Œãã‚Œ{z},{x},{y}ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€
    //	ll: ç·¯åº¦çµŒåº¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆlat,lngãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã¾ã™ï¼‰
    //  z:ã€€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
    //  factor: æ•°å€¤ã‚’æ±‚ã‚ã‚‹ã¨ãã«ä½¿ç”¨ã™ã‚‹ä¿‚æ•°ï¼Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1
    //  offset: æ•°å€¤ã‚’æ±‚ã‚ã‚‹ã¨ãã«ä½¿ç”¨ã™ã‚‹ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0
    //  invalid: è¿½åŠ ç„¡åŠ¹å€¤ã‚’ç›¸å½“ã™ã‚‹æ•°å€¤ã§æŒ‡å®šï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æŒ‡å®šãªã—
    //  æˆ»ã‚Šå€¤: æˆåŠŸæ™‚ã«æ•°å€¤ã‚’å—ã‘å–ã‚‹ãƒ—ãƒ­ãƒŸã‚¹ï¼ç„¡åŠ¹å€¤ã®å ´åˆã¯NaNã‚’å—ã‘å–ã‚Šã¾ã™
    /// ****************
    function getNumericalValue(url, lat, lng, z, factor = 1, offset = 0, invalid = undefined) {
      console.log("z=" + z + " " + "lat=" + lat + " " + "lng=" + lng);
      return new Promise(function (resolve, reject) {
        const
          p = latLngToTile(lat, lng, z),
          x = Math.floor(p.x),			// ã‚¿ã‚¤ãƒ«Xåº§æ¨™
          y = Math.floor(p.y),			// ã‚¿ã‚¤ãƒ«Yåº§æ¨™
          i = (p.x - x) * 256,			// ã‚¿ã‚¤ãƒ«å†…iåº§æ¨™
          j = (p.y - y) * 256,			// ã‚¿ã‚¤ãƒ«å†…jåº§æ¨™
          img = new Image();

        console.log("ã‚¿ã‚¤ãƒ«URL=" + url);
        // console.log("z=" + z + " " + "lat=" + lat + " " + "lng=" + lng);
        console.log("ã‚¿ã‚¤ãƒ«Xåº§æ¨™=" + x + " " + "ã‚¿ã‚¤ãƒ«Yåº§æ¨™=" + y);

        img.crossOrigin = 'anonymous';	// ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™ãŸã‚ã«å¿…è¦ã§ã™
        img.onload = function () {
          const
            canvas = document.createElement('canvas'),
            context = canvas.getContext('2d');
          let
            r2,
            v,
            data;

          canvas.width = 1;
          canvas.height = 1;
          context.drawImage(img, i, j, 1, 1, 0, 0, 1, 1);
          data = context.getImageData(0, 0, 1, 1).data;
          r2 = (data[0] < 2 ** 7) ? data[0] : data[0] - 2 ** 8;
          v = r2 * 2 ** 16 + data[1] * 2 ** 8 + data[2];
          if (data[3] !== 255 || (invalid != undefined && v == invalid)) {
            v = NaN;
          }
          resolve(v * factor + offset);
        }
        img.onerror = function () {
          reject(null);
        }
        img.src = url.replace('{z}', z).replace('{y}', y).replace('{x}', x);
      });
    };

  </script>
</body>

</html>